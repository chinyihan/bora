<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Designer</title>
  <meta name="description" 
          content="Designer Drawing Block.">
  <link rel="stylesheet" href="{{ static_url("style.css") }}">
  <link rel="stylesheet" href="{{ static_url("jquery-ui.min.css") }}">
  <!--[if IE]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>

<body>
<div id="page_designer_info">[VER {{ data['version'] }}] {{ data['title'] }}. Designer Block.     </div>
<div id="page_title_cache" style="display:none;">{{ data['title'] }}</div>
<div id="page_version_cache" style="display:none;">{{ data['version'] }}</div>

<img src="{{ static_url( 'background.png' ) }}"></img>


<!--<button class="button hide-control" onclick="hidecontrol()">Control Panel</button>-->
<!--<button id="toggle-panel" class="button showhide" onclick="showhide()">ADEI</button>-->

{% if data['style'] %}
{% for key in data['style'] %}

{% if data['style'][key]['type'] == "adei" %}
<div id='{{ key }}' class='varbox' data-type="{{ data['style'][key]['type'] }}" data-decimal-numbers="{{ data['style'][key]['div']['data-decimal-numbers'] }}" data-smaller-than="{{ data['style'][key]['div']['data-smaller-than'] }}" data-larger-than="{{ data['style'][key]['div']['data-larger-than'] }}" data-exp="{{ data['style'][key]['div']['data-exp'] }}" data-link-adei="{{ data['style'][key]['div']['data-link-adei'] }}" data-trend="{{ data['style'][key]['div']['data-trend'] }}" style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }}; width:{{ data['style'][key]['width'] }}px;
    height:{{ data['style'][key]['height'] }}px; font-size: {{ data['style'][key]['div']['font-size'] }}; font-weight: {{ data['style'][key]['div']['font-weight'] }}; background-color: {{ data['style'][key]['div']['background-color'] }};' data-type='adei'>
    <span class='text_name'>{{ data['style'][key]['div']['text-name'] }}</span> <span class='value'>XXX.XX</span> <span class='unit_name'>{{ data['style'][key]['div']['unit-name'] }}</span>
</div>
{% else %}
{% end %}

{% if data['style'][key]['type'] == "graph" %}
<div id="{{ key }}" class="varbox hover-box" style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }}; width:{{ data['style'][key]['width'] }}px;
    height:{{ data['style'][key]['height'] }}px;' data-type='graph'>
</div>
{% else %}
{% end %}

{% if data['style'][key]['type'] == "iframe" %}
<div id="{{ key }}" class="varbox hover-box" style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }}; width:{{ data['style'][key]['width'] }}px;
    height:{{ data['style'][key]['height'] }}px;' data-type='iframe'>
</div>
{% else %}
{% end %}

{% if data['style'][key]['type'] == "readonly" %}
<div id='{{ key }}' class='varbox' style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }}; width:{{ data['style'][key]['width'] }}px;
    height:{{ data['style'][key]['height'] }}px;' data-type='text'>
<span style='color: #000; font-size: {{ data['style'][key]['div']['font-size'] }}; font-weight: {{ data['style'][key]['div']['font-weight'] }};' class='title'>{{ data['style'][key]['div']['text-name'] }}</span> 
</div>
{% else %}
{% end %}

{% if data['style'][key]['type'] == "text" %}
<div id='{{ key }}' class='varbox' data-title-link="{{ data['style'][key]['div']['data-title-link'] }}" style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }}; width:{{ data['style'][key]['width'] }}px;
    height:{{ data['style'][key]['height'] }}px; font-size: {{ data['style'][key]['div']['font-size'] }}; font-weight: {{ data['style'][key]['div']['font-weight'] }};' data-type='text'>
    <span class='text_name'>{{ data['style'][key]['div']['text-name'] }}</span>
</div>
{% else %}
{% end %}

{% if data['style'][key]['type'] == "button" %}
<div id='{{ key }}' class='varbox' style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }};
    height:{{ data['style'][key]['height'] }}px;' data-type='button'>
    <button style='font-size:{{ data['style'][key]['button']['font-size'] }}; width:{{ data['style'][key]['button']['width'] }}'><span style='color: #000; font-size: {{ data['style'][key]['div']['font-size'] }}; font-weight: {{ data['style'][key]['div']['font-weight'] }};' class='title'>{{ data['style'][key]['div']['text-name'] }}</span></button>
</div>
{% else %}
{% end %}

{% if data['style'][key]['type'] == "input" %}
<div id='{{ key }}' class='varbox' style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }};
    height:{{ data['style'][key]['height'] }}px;' data-type='input'><span style='color: #000; font-size: {{ data['style'][key]['div']['font-size'] }}; font-weight: {{ data['style'][key]['div']['font-weight'] }};' class='title'>{{ data['style'][key]['div']['text-name'] }}</span> <input type='text' style='font-size:{{ data['style'][key]['input']['font-size'] }}; width:{{ data['style'][key]['input']['width'] }}'></div>
{% else %}
{% end %}

{% if data['style'][key]['type'] == "rest" %}
<div id='{{ key }}' class='varbox' style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }};
    height:{{ data['style'][key]['height'] }}px;' data-type='rest'><p><span style='color: #000; font-size: {{ data['style'][key]['div']['font-size'] }}; font-weight: {{ data['style'][key]['div']['font-weight'] }};' class='title'>{{ data['style'][key]['div']['text-name'] }}</span> <input type='text' style='font-size:{{ data['style'][key]['input']['font-size'] }}; width:{{ data['style'][key]['input']['width'] }}'></div>
{% else %}
{% end %}

{% if data['style'][key]['type'] == "box" %}
<div id='{{ key }}' class='varbox' style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }}; width:{{ data['style'][key]['width'] }}px;
    height:{{ data['style'][key]['height'] }}px; font-weight: {{ data['style'][key]['div']['font-weight'] }};' data-type='box'>
    <span class='text_name'>{{ data['style'][key]['div']['text-name'] }}</span>
</div>
{% else %}
{% end %}

{% if data['style'][key]['type'] == "hls" %}
<div id='{{ key }}' class='varbox' style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }}; width:{{ data['style'][key]['width'] }}px;
    height:{{ data['style'][key]['height'] }}px;' data-type='hls'>{{ key }}</div>
{% else %}
{% end %}

{% if data['style'][key]['type'] == "rtsp" %}
<div id='{{ key }}' class='varbox' style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }}; width:{{ data['style'][key]['width'] }}px;
    height:{{ data['style'][key]['height'] }}px;' data-type='rtsp'>{{ key }}</div>
{% else %}
{% end %}

    
{% if data['style'][key]['type'] == "calc" %}
<div id='{{ key }}' class='varbox' data-type="{{ data['style'][key]['type'] }}" data-formula="{{ data['style'][key]['div']['data-formula'] }}" data-decimal-numbers="{{ data['style'][key]['div']['data-decimal-numbers'] }}" data-smaller-than="{{ data['style'][key]['div']['data-smaller-than'] }}" data-larger-than="{{ data['style'][key]['div']['data-larger-than'] }}" style='position: absolute; top: {{ data['style'][key]['top'] }}; 
    left:{{ data['style'][key]['left'] }}; width:{{ data['style'][key]['width'] }}px; height:{{ data['style'][key]['height'] }}px; font-size: {{ data['style'][key]['div']['font-size'] }}; font-weight: {{ data['style'][key]['div']['font-weight'] }};'>
    <span class='text_name'>{{ data['style'][key]['div']['text-name'] }}</span> <span class='value'>XXX.XX</span> <span class='unit_name'>{{ data['style'][key]['div']['unit-name'] }}</span>
</div>
{% else %}
{% end %}

{% if data['style'][key]['type'] == "virtual" %}
<div id='{{ key }}' class='varbox' data-type="{{ data['style'][key]['type'] }}" data-virtual-id="{{ data['style'][key]['div']['data-virtual-id'] }}" data-decimal-numbers="{{ data['style'][key]['div']['data-decimal-numbers'] }}" data-smaller-than="{{ data['style'][key]['div']['data-smaller-than'] }}" data-larger-than="{{ data['style'][key]['div']['data-larger-than'] }}" data-exp="{{ data['style'][key]['div']['data-exp'] }}" data-link-adei="{{ data['style'][key]['div']['data-link-adei'] }}" data-trend="{{ data['style'][key]['div']['data-trend'] }}" style='position: absolute; top: {{ data['style'][key]['top'] }}; 
    left:{{ data['style'][key]['left'] }}; width:{{ data['style'][key]['width'] }}px; height:{{ data['style'][key]['height'] }}px; font-size: {{ data['style'][key]['div']['font-size'] }}; font-weight: {{ data['style'][key]['div']['font-weight'] }};'>
    <span class='text_name'>{{ data['style'][key]['div']['text-name'] }}</span> <span class='value'>XXX.XX</span> <span class='unit_name'>{{ data['style'][key]['div']['unit-name'] }}</span>
</div>
{% else %}
{% end %}

{% if data['style'][key]['type'] == "clone" %}
<div id='{{ key }}' class='varbox' data-type="{{ data['style'][key]['type'] }}" data-clone-id="{{ data['style'][key]['div']['data-clone-id'] }}" style='position: absolute; top: {{ data['style'][key]['top'] }}; 
    left:{{ data['style'][key]['left'] }};'>
</div>
{% else %}
{% end %}

{% if data['style'][key]['type'] == "icon" %}
<div id='{{ key }}' class='varbox' data-type="{{ data['style'][key]['type'] }}" data-icon-type="{{ data['style'][key]['div']['data-icon-type'] }}" data-onCondition="{{ data['style'][key]['div']['data-onCondition'] }}" data-link-adei="{{ data['style'][key]['div']['data-link-adei'] }}" data-trend="{{ data['style'][key]['div']['data-trend'] }}"
    style='position: absolute; top:{{ data['style'][key]['top'] }}; left:{{ data['style'][key]['left'] }}; rotate:{{ data['style'][key]['div']['rotate'] }};'>
    <img width='{{ data['style'][key]['width'] }}' height='{{ data['style'][key]['height'] }}' src="{{ static_url( data['style'][key]['div']['data-icon-type'] + '_inactive.png' ) }}"></img>
</div>
{% else %}
{% end %}


{% if data['style'][key]['type'] == "integer-to-string" %}
<div id='{{ key }}' class='varbox' data-type="{{ data['style'][key]['type'] }}" data-int-to-str="{{ data['style'][key]['div']['data-int-to-str'] }}" data-link-adei="{{ data['style'][key]['div']['data-link-adei'] }}" data-trend="{{ data['style'][key]['div']['data-trend'] }}" style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }}; font-size: {{ data['style'][key]['div']['font-size'] }}; font-weight: {{ data['style'][key]['div']['font-weight'] }}; background-color: {{ data['style'][key]['div']['background-color'] }};'>
    <span class='text_name'>{{ data['style'][key]['div']['text-name'] }}</span> <span>???</span>
</div>
{% else %}
{% end %}


{% if data['style'][key]['type'] == "header" %}
<div style='position: absolute; top: {{ data['style'][key]['top'] }}; left:{{
    data['style'][key]['left'] }}; width:{{ data['style'][key]['width'] }}px;
    height:{{ data['style'][key]['height'] }}px;
{% if "background_color" in data['style'][key] %}    
background-color:{{ data['style'][key]['background_color'] }};'
{% else %}
{% end %}
{% if "titlelink" in data['style'][key] %}
data-titlelink="{{ data['style'][key]['titlelink'] }}"
{% else %}
{% end %}
data-type="{{ data['style'][key]['type'] }}" class='varbox' id="{{ key }}">
<p><span style="color: #000; font-size: {{ data['style'][key]['header']['size'] }}px; font-weight: {{ data['style'][key]['header']['weight'] }};" class="title">{{ data['style'][key]['header']['title'] }} </span></p>
</div>
{% else %}
{% end %}


{% end %}

{% else %}
{% end %}


<!-- java script -->
<script src="{{ static_url("jquery-1.12.3.min.js") }}"></script>
<script src="{{ static_url("jquery-ui.min.js") }}"></script>
<script src="{{ static_url("dat.gui.js") }}"></script>

<script>

var varname;

    
function add_rest() {
    var varname2 = $("#varname2 option:selected").text();
        
    if (document.getElementById(varname2)) {
        alert('this record already exists');
        return;
    }

    var html_text = "<div id='" + varname2 + "' style='position: absolute;top:200px;left:200px' " +
        "background-color:" + $("#background_color_rest").val() + ";' class='varbox' data-type='rest'>" +
        "<p><span style='margin-right: 20px;color: #000; font-size: " + $("#elem_title_size_rest").val() + "px; font-weight: " + $("#elem_title_style_rest").val() + ";' class='title'>" + $("#elem_title_text_rest").val() + "</span> <input type='text' style='font-size:" + $("#elem_input_size_rest").val() + "px; width= " + $("#elem_input_width_rest").val() + "px;'></p></div>"
    
        
    $( "body" ).append(html_text);
    $("#"+varname2).draggable();
    $("#"+varname2).resizable();
        
    $('#'+varname2).click(function() {
        varname = $(this).attr("id");
        $("#varname2").val($(this).attr("id"));
        $("#buttonHighlight").trigger("click");
    });
    
    $("#"+varname2+" > input").keydown(function(e){

        if(e.which == 13) {
            e.preventDefault();
            $(this).css("background-color", "yellow");
            /*
            var id = $(this).attr('id');
            var value = $(this).val();

            alert('Enter pressed for '+id+'\n'+
              'Value = '+value;
            )
             */
            
            return false;
        }
        
    });
}
    
function add_rtsp() {
    var varname3 = $("#varname3 option:selected").text();
    
    if (document.getElementById(varname3)) {
      alert('this record already exists');
      return;
    }

    //var html_text = "<div id='varname3' style='position: absolute;top:0;left:200px;' class='varbox box_highlight'><iframe src='http://localhost:1984/stream.html?src=test&mode=webrtc' width='400' height='400'></iframe></div>"
    var html_text = "<div id='" + varname3 + "' style='position: absolute;top:0;left:200px; width:" + ($("#rtsp_width").val()).toString() + "px; height:" + ($("#rtsp_height").val()).toString() + "px' class='varbox' data-type='rtsp'>" + varname3 + "</div>"
    
    //<iframe src='' width='400' height='400'></iframe>
    
    $( "body" ).append(html_text);
    $("#"+varname3).draggable();
    //$("#camera01").resizable();
    
    $('#'+varname3).click(function() {
        varname = $(this).attr("id");
        $("#varname3").val($(this).attr("id"));
        $("#buttonHighlight").trigger("click");
        
    });
}
    
function add() {

    title_text = $("#elem_title_text").val();
    title_text = title_text.trim();
    title_color = "#000000";
    //title_color = $("#elem_title_color").val();
    title_size = $("#elem_title_size").val();
    title_style = $("#elem_title_style option:selected").val();
    
    unit_text = $("#elem_unit_text").val();
    unit_text = unit_text.trim();
    unit_color = "#000";
    //unit_color = $("#elem_unit_color").val();
    unit_size = $("#elem_unit_size").val();
    unit_style = $("#elem_unit_style option:selected").val();
    
    data_condition = $("#elem_condition_range").val();
    //data_max = $("#elem_max_range").val();
    
    data_formula = $("#elem_formula").val();
    
    
    virtual_id = $("#virtual_id_text").val();
    virtual_id = virtual_id.trim();
    if (virtual_id == "") {
        virtual_id = "0";
    }
    
    
    if ($('#elem_exponential').is(":checked")) {
        data_exponential = true;
        //$("#"+key).attr("data-exponential", true);
    } else {
        data_exponential = false;
        //$("#"+key).attr("data-exponential", false);
    }
    if ($('#elem_linkhtml').is(":checked")) {
        data_linkhtml = true;
        //$("#"+key).attr("data-linkhtml", true);
    } else {
        data_linkhtml = false;
        //$("#"+key).attr("data-linkhtml", false);
    }
     
    if ($('#elem_trend').is(":checked")) {
        data_trend = true;
        //$("#"+key).attr("data-trend", true);
    } else {
        data_trend = false;
        //$("#"+key).attr("data-trend", false);
    }
    
 
    data_lesser = $("#elem_lesser_range").val();
    data_larger = $("#elem_larger_range").val();
    decimal_place = $("#decimal_place").val();
    titlelink = $("#titlelink").val();
    background_color = $("#background_color").val(); 
    varval = $( "#varname option:selected").val();
    varname = $("#varname option:selected").text();
    
    vartype = $("#vartype option:selected").val();
    
    icon = $("#icon option:selected").val();
    onexpression = $("#onexpression option:selected").val();
    onvalue = $("#onvalue").val();
    offexpression = $("#offexpression option:selected").val();
    offvalue = $("#offvalue").val();
    varattr = $("#varattr option:selected").val();
    rotate = $("#rotate").val(); 
    
        
    if(($("#" + varname).length == 0) || (vartype=="header") || (vartype=="calc") || (varattr=="virtual")) {
    
        if (vartype == "data") {
            
            if (varattr=="virtual") {
                virtual_name = "virtual_" + varname + "_" + virtual_id;
                if ( $("#" + virtual_name).length > 0 ) {
                    for (i = 0; i < 50; i++) { 
                        virtual_name = "virtual_" + varname + "_" + i.toString();
                        
                        if (!$("#" + virtual_name).length){
                            break;
                         }
                    }
                }
                varname = virtual_name;
            }
            
            html_text = "<div " +
                    "style='position: absolute; " +
                           "top:0; " +
                           "left:0; " +
                           "background-color:" + background_color + "'" +
                    "class='varbox box_highlight' " +
                    "id='" + varname +
                    "' data-type='" + vartype +
                    "' data-cond='" + data_condition +
                    "' data-formula='" + data_formula +
                    "' data-lesser='" + data_lesser + 
 		            "' data-larger='" + data_larger + 
                    "' data-exponential='" + data_exponential +
                    "' data-linkhtml='" + data_linkhtml +
                    "' data-trend='" + data_trend +
                    "' data-decimal='" + decimal_place +
                    "'>" +
                    "<p>" +
                    "<span style='color: " + title_color + ";" + 
                    "font-size:" + title_size + "px; " + 
                    "font-weight: " + title_style + ";' " + 
                    "class='title'>" + title_text +
                    " </span>" + 
                    "<span style='color: " + unit_color + "; " + 
                        "font-size:" + unit_size + "px; " +
                        "font-weight: " + unit_style + ";' " + 
                        "class='varval'>XXX.XX </span>" + 
                    "<span style='color: " + unit_color + "; " + 
                        "font-size:" + unit_size + "px; " +
                        "font-weight: " + unit_style + ";' " + 
                        "class='unit_title'>" + unit_text + "</span></p>" +
        	    "</div>";
        } else if (vartype == "header") {
            
            if (title_text.length > 0) { 
                var clean_text = title_text.replace(/[^a-zA-Z0-9 ]/g, "")
                varname = "header_" + clean_text.replace(/\s+/g, '-').toLowerCase();
                html_text = "<div " +
                        "style='position: absolute; " +
                               "top:0; " +
                               "left:0; " +
                               "background-color:" + background_color + "'" +
                        "class='varbox box_highlight' " + 
                        "id='" + varname +
                        "' data-type='" + vartype +
                        "' data-cond='" + data_condition +
                        "' data-titlelink='" + titlelink +
                        "' data-lesser='" + data_lesser + 
 		                "' data-larger='" + data_larger + 
                        "'>" +
                        "<p>" +
                        "<span style='color: " + title_color + ";" + 
                        "font-size:" + title_size + "px; " + 
                        "font-weight: " + title_style + ";' " + 
                        "class='title'>" + title_text +
                        " </span></p>" + 
        	        "</div>";
            
                $('#varname').append($('<option>', {
                    value: varname,
                    text: varname
                }));
                $('#varname').val(varname);
                $('#elem_title_text').removeClass('glowing_border');
            } else {
                
                html_text = "";
                $('#elem_title_text').addClass('glowing_border');
            }
        } else if (vartype == "calc") {
            
            if (data_formula.length > 0) {
                var clean_text = data_formula.replace(/[^a-zA-Z0-9 ]/g, "")
                varname = "calc_" + clean_text.replace(/\s+/g, '-').toLowerCase();
                
                html_text = "<div " +
                        "style='position: absolute; " +
                               "top:0; " +
                               "left:0; " +
                               "background-color:" + background_color + "'" +
                        "class='varbox box_highlight' " + 
                        "id='" + varname +
                        "' data-type='" + vartype +
                        "' data-cond='" + data_condition +
                        "' data-lesser='" + data_lesser + 
 		                "' data-larger='" + data_larger +
                        "' data-formula='" + data_formula +
                        "' data-decimal='" + decimal_place +
                        "'>" +
                        "<p>" +
                        "<span style='color: " + title_color + ";" + 
                        "font-size:" + title_size + "px; " + 
                        "font-weight: " + title_style + ";' " + 
                        "class='title'>" + title_text +
                        " </span>" + 
                        "<span style='color: " + unit_color + "; " + 
                               "font-size:" + unit_size + "px; " +
                               "font-weight: " + unit_style + ";' " + 
                        "class='varval'>XXX.XX </span>" + 
                        "<span style='color: " + unit_color + "; " + 
                            "font-size:" + unit_size + "px; " +
                            "font-weight: " + unit_style + ";' " + 
                            "class='unit_title'>" + unit_text + "</span></p>" +
        	        "</div>";
            
                $('#varname').append($('<option>', {
                    value: varname,
                    text: varname
                }));
                $('#varname').val(varname);
                $('#elem_formula').removeClass('glowing_border');
            } else {
                
                html_text = "";
                $('#elem_formula').addClass('glowing_border');
            }
            
        } else if (vartype == "icon") {
                if (varattr=="virtual") {
                    virtual_name = "virtual_" + varname + "_" + virtual_id;
                    if ( $("#" + virtual_name).length > 0 ) {
                        for (i = 0; i < 50; i++) {
                            virtual_name = "virtual_" + varname + "_" + i.toString();
                            
                            if (!$("#" + virtual_name).length){
                                break;
                            }
                        }
                    }
                    varname = virtual_name;
                }
                
                if ((onvalue.length > 0)&&(offvalue.length > 0)) {
                    //var token = JSON.parse(unit_text);
                    //data_on = token["on"];
                    //data_off = token["off"];
                    html_text = "<div " +
                        "style='position: absolute; " +
                               "top:0; " +
                               "left:0; " +
                               "background-color:" + background_color + "'" +
                        "class='varbox box_highlight' " +
                        "id='" + varname +
                        "' data-type='" + vartype +
                        "' data-cond='" + data_condition +
                        "' data-icon='" + icon +
                        "' data-lesser='" + data_lesser +
                                "' data-larger='" + data_larger +
                                "' data-onexpression='" + onexpression +
                                "' data-on='" + onvalue +
                                "' data-offexpression='" + offexpression +
                                "' data-off='" + offvalue +
                        "' data-linkhtml='" + data_linkhtml +
                        "' data-trend='" + data_trend +
                        "'>" +
                        "<img width='100%' height='100%' " +
                            "style='transform:rotate(" + rotate + ")'" +
                            "src='/static/" + icon + "_inactive.svg' ></img>" +
                        "</div>";
                     $('#onvalue').removeClass('glowing_border');
                     $('#offvalue').removeClass('glowing_border');
                 } else{
                    
                     html_text = "";
                     $('#onvalue').addClass('glowing_border');
                     $('#offvalue').addClass('glowing_border');
                 }
         
	} else if (vartype == "integer-to-string") {
            if (varattr=="virtual") {
                virtual_name = "virtual_" + varname + "_" + virtual_id;
                if ( $("#" + virtual_name).length > 0 ) {
                    for (i = 0; i < 50; i++) {
                        virtual_name = "virtual_" + varname + "_" + i.toString();
                        
                        if (!$("#" + virtual_name).length){
                            break;
                        }
                    }
                }
                varname = virtual_name;
            }
            
            if (unit_text.length > 0) {
                html_text = "<div " +
                        "style='position: absolute; " +
                               "top:0; " +
                               "left:0; " +
                               "background-color:" + background_color + "'" +
                        "class='varbox box_highlight' " + 
                        "id='" + varname +
                        "' data-type='" + vartype +
                        "' data-dict='" + unit_text +
                        "' data-cond='" + data_condition +
                        "' data-linkhtml='" + data_linkhtml +
                        "' data-trend='" + data_trend +
                        "'>" +
                        "<p>" +
                        "<span style='color: " + title_color + ";" + 
                        "font-size:" + title_size + "px; " + 
                        "font-weight: " + title_style + ";' " + 
                        "class='title'>" + title_text +
                        " </span><br />" + 
                        "<span style='color: " + unit_color + "; " + 
                               "font-size:" + unit_size + "px; " +
                               "font-weight: " + unit_style + ";' " + 
                        "class='varval'>??? o/soan>" + 
                        "</p>" +
        	            "</div>";
                $('#elem_unit_text').removeClass('glowing_border');
            } else {
                
                html_text = "";
                $('#elem_unit_text').addClass('glowing_border');
            }
        }
        
        if (html_text.length > 0) {
            $( "body" ).append(html_text);
            $("#"+varname).draggable();
            $("#"+varname).resizable();
        }
    }
}
    
    
function mysave(data) {
    
    varname = $("#varname option:selected").text();
    varattr = $("#varattr option:selected").val();
    
    var position = {};
    for(key in data) {
        var tmp = {};
        
        if($("#" + key).length > 0 ) {
            tmp["ref"] = key;
            tmp["left"] = $("#"+key).css("left");
            tmp["top"] = $("#"+key).css("top");
            tmp["width"] = $("#"+key).width();
            tmp["height"] = $("#"+key).height();
            tmp["type"] = $("#"+key).attr("data-type");
            if ( $("#"+key).attr("data-type") == "data" ) {
                if ( (varname == key) && (varattr == "normal") ) {
                    tmp["condition"] = $("#elem_condtion_range").val();
            	    tmp["formula"] = $("#elem_formula").val();
             	    tmp["lesser"] = $("#elem_lesser_range").val();
            	    tmp["larger"] = $("#elem_larger_range").val();
		    tmp["decimal"] = $("#decimal_place").val();
                    if ($('#elem_exponential').is(":checked")) {
                        tmp["exponential"] = "true";
			$("#"+key).attr("data-exponential", "true");
                    } else {
                        tmp["exponential"] = "false";
			$("#"+key).attr("data-exponential", "false");
                    }
                    if ($('#elem_linkhtml').is(":checked")) {
                        tmp["linkhtml"] = "true";
			$("#"+key).attr("data-linkhtml", "true");
                    } else {
                        tmp["linkhtml"] = "false";
			$("#"+key).attr("data-linkhtml","false");
                    }
                    if ($('#elem_trend').is(":checked")) {
                        tmp["trend"] = "true";
                        $("#"+key).attr("data-trend", "true");
                    } else {
                        tmp["trend"] = "false";
                        $("#"+key).attr("data-trend","false");
                    }
            	    if ($('#background_color').val().length > 0) {
                        tmp["background_color"] = $('#background_color').val();
                    } else {
                        tmp["background_color"] = '#0000';
                    } 
                    
                    header = {};
            	    header["title"] = $("#elem_title_text").val().trim();
            	    //header["color"] = $(".title", "#"+key).css("color");
            	    header["size"] = $("#elem_title_size").val();
            	    header["weight"] = $("#elem_title_style").val();
         
                    // update field
                    $(".title", "#"+key).text(header["title"]);
                    $(".title", "#"+key).css("font-size", header["size"] + "px");
                    $(".title", "#"+key).css("font-weight", header["weight"]);

            	    unit = {};
            	    unit["title"] = $("#elem_unit_text").val().trim();
            	    //unit["color"] = $(".varval", "#"+key).css("color");
            	    unit["size"] = $("#elem_unit_size").val();
            	    unit["weight"] = $("#elem_unit_style").val();
                    $(".varval", "#"+key).css("font-size", unit["size"] + "px");
                    $(".unit_title", "#"+key).css("font-size", unit["size"] + "px");
                    $(".unit_title", "#"+key).css("font-weight", unit["weight"]);                    
                    $(".varval", "#"+key).css("font-weight", unit["weight"]);

                } else {
            	    tmp["condition"] = $("#"+key).attr("data-cond");
            	    tmp["formula"] = $("#"+key).attr("data-formula");
             	    tmp["lesser"] = $("#"+key).attr("data-lesser");
            	    tmp["larger"] = $("#"+key).attr("data-larger");
                    tmp["exponential"] = $("#"+key).attr("data-exponential");
                    tmp["linkhtml"] = $("#"+key).attr("data-linkhtml");
                    tmp["trend"] = $("#"+key).attr("data-trend");
		    tmp["decimal"] = $("#"+key).attr("data-decimal") || 2;
             	    //tmp["min"] = $("#"+key).attr("min");
           	    //tmp["max"] = $("#"+key).attr("max");
                    header = {};
            	    header["title"] = $(".title", "#"+key).text();
            	    //header["color"] = $(".title", "#"+key).css("color");
            	    header["size"] = parseInt($(".title", "#"+key).css("font-size")) || 28;
                    tmp["background_color"] = $("#"+key).css("background-color");

                    var fontWeight = $(".title", "#"+key).css("font-weight");
                    if (fontWeight == 'bold' || fontWeight == '700') {
            	        header["weight"] = "700";
                    } else {
            	        header["weight"] = "400";
                    }
                    
            
            	    unit = {};
            	    unit["title"] = $(".unit_title", "#"+key).text();
            	    //unit["color"] = $(".varval", "#"+key).css("color");
            	    unit["size"] = parseInt($(".varval", "#"+key).css("font-size")) || 28;
                    
                    fontWeight = $(".varval", "#"+key).css("font-weight");
                    if (fontWeight == 'bold' || fontWeight == '700') {
            	        unit["weight"] = "700";
                    } else {
            	        unit["weight"] = "400";
                    }
                }
            	tmp["header"] = header;
            	tmp["unit"] = unit;
            //} else if ( $("#"+key).attr("data-type") == "header" ) {
	    //	header = {};
	    //	header["title"] = $(".title", "#"+key).text();
	    //	header["size"] = $(".title", "#"+key).css("font-size");
	    //	header["weight"] = $(".title", "#"+key).css("font-weight");
            //	tmp["header"] = header;
           } else if ( $("#"+key).attr("data-type") == "icon" ) {
                if ((varname == key) && (varattr == "normal")) {
                    //var unit_text = $("#elem_unit_text").val();
                    //unit_text = unit_text.trim();
                    //var dtoken = JSON.parse(unit_text);
                    tmp["on"] = $("#onvalue").val();
                    tmp["on_condition"] = $("#onexpression").val();
                    tmp["off"] = $("#offvalue").val();
                    tmp["off_condition"] = $("#offexpression").val();
                    tmp["icon"] = $("#"+key).attr("data-icon");
		    tmp["rotate"] = "rotate(" + $("#rotate").val() + "deg)";
                    if ($('#elem_linkhtml').is(":checked")) {
                        tmp["linkhtml"] = "true";
                        $("#"+key).attr("data-linkhtml", "true");
                    } else {
                        tmp["linkhtml"] = "false";
                        $("#"+key).attr("data-linkhtml","false");
                    }
                    if ($('#elem_trend').is(":checked")) {
                        tmp["trend"] = "true";
                        $("#"+key).attr("data-trend", "true");
                    } else {
                        tmp["trend"] = "false";
                        $("#"+key).attr("data-trend","false");
                    }
                    if ($('#background_color').val().length > 0) {
                        tmp["background_color"] = $('#background_color').val();
                    } else {
                        tmp["background_color"] = '#0000';
                    }
                } else {
                    tmp["icon"] = $("#"+key).attr("data-icon");
                    tmp["on"] = $("#"+key).attr("data-on");
                    tmp["on_condition"] = $("#"+key).attr("data-onexpression");
                    tmp["off"] = $("#"+key).attr("data-off");
                    tmp["off_condition"] = $("#"+key).attr("data-offexpression");
                    tmp["linkhtml"] = $("#"+key).attr("data-linkhtml");
                    tmp["trend"] = $("#"+key).attr("data-trend");
                    tmp["rotate"] = $("#"+key).children().css("transform");
                    tmp["background_color"] = $("#"+key).css("background-color");
                }
            } else if ( $("#"+key).attr("data-type") == "integer-to-string" ) {
                if ((varname == key)&& (varattr == "normal")) {
                    var unit_text = $("#elem_unit_text").val();
                    unit_text = unit_text.trim();
                    var data_condition = $("#elem_condition_range").val();
            	    tmp["cond"] = data_condition;
            	    tmp["dict"] = unit_text;
             	    if ($('#elem_linkhtml').is(":checked")) {
                        tmp["linkhtml"] = "true";
                        $("#"+key).attr("data-linkhtml", "true");
                    } else {
                        tmp["linkhtml"] = "false";
                        $("#"+key).attr("data-linkhtml","false");
                    }
                    if ($('#elem_trend').is(":checked")) {
                        tmp["trend"] = "true";
                        $("#"+key).attr("data-trend", "true");
                    } else {
                        tmp["trend"] = "false";
                        $("#"+key).attr("data-trend","false");
                    } 
                    if ($('#background_color').val().length > 0) {
                        tmp["background_color"] = $('#background_color').val();
                    } else {
                        tmp["background_color"] = '#0000';
                    }
            	    header = {};
            	    header["title"] = $("#elem_title_text").val().trim();
            	    header["size"] = $("#elem_title_size").val();
            	    header["weight"] = $("#elem_title_style").val();
            
            	    unit = {};
            	    //unit["color"] = $(".varval", "#"+key).css("color");
            	    unit["size"] = $("#elem_unit_size").val();
            	    unit["weight"] = $("#elem_unit_style option:selected").val();
                } else {
            	    tmp["dict"] = $("#"+key).attr("data-dict");
            	    tmp["cond"] = $("#"+key).attr("data-cond");
            	    tmp["background_color"] = $("#"+key).css("background-color");
                    tmp["linkhtml"] = $("#"+key).attr("data-linkhtml");
                    tmp["trend"] = $("#"+key).attr("data-trend");
                    header = {};
            	    header["title"] = $(".title", "#"+key).text();
            	    //header["color"] = $(".title", "#"+key).css("color");
            	    header["size"] = $(".title", "#"+key).css("font-size");
            	    header["weight"] = $(".title", "#"+key).css("font-weight");
            
            	    unit = {};
            	    //unit["title"] = $(".unit_title", "#"+key).text();
            	    //unit["color"] = $(".varval", "#"+key).css("color");
            	    unit["size"] = $(".varval", "#"+key).css("font-size");
            	    unit["weight"] = $(".varval", "#"+key).css("font-weight");
                }
            	tmp["header"] = header;
            	tmp["unit"] = unit;
            }
            position[key] = tmp;
        }
    }
    
    var title_text = $("#elem_title_text").val();
    title_text = title_text.trim();
    
    var clean_text = title_text.replace(/[^a-zA-Z0-9 ]/g, "")
    var token = "header_" + clean_text.replace(/\s+/g, '-').toLowerCase();
    $('[id^=virtual_]').each(function( index ) {
        var tmp = {};
        var key = this.id;
        var ref = key.split("_");
        ref.shift();
        ref.pop();
        ref = ref.join("_");
        //ref = ref[1];
        if (key != "virtual_id_text") {
            
        
        if($("#" + key).length > 0 ) {
            tmp["ref"] = ref;
            tmp["left"] = $("#"+key).css("left");
            tmp["top"] = $("#"+key).css("top");
            tmp["width"] = $("#"+key).width();
            tmp["height"] = $("#"+key).height();
            tmp["type"] = $("#"+key).attr("data-type");
            
            if ( $("#"+key).attr("data-type") == "data" ) {
                if (varname == key) {
            	    tmp["condition"] = $("#elem_condtion_range").val();
            	    tmp["formula"] = $("#elem_formula").val();
             	    tmp["lesser"] = $("#elem_lesser_range").val();
            	    tmp["larger"] = $("#elem_larger_range").val();
                    tmp["decimal"] = $("#decimal_place").val();
            
            	    header = {};
            	    header["title"] = $("#elem_title_text").val().trim();
            	    //header["color"] = $(".title", "#"+key).css("color");
            	    header["size"] = $("#elem_title_size").val();
            	    header["weight"] = $("#elem_title_style option:selected").val();
                    if ($('#elem_linkhtml').is(":checked")) {
                        tmp["linkhtml"] = "true";
                        $("#"+key).attr("data-linkhtml", "true");
                    } else {
                        tmp["linkhtml"] = "false";
                        $("#"+key).attr("data-linkhtml","false");
                    }
                    if ($('#elem_trend').is(":checked")) {
                        tmp["trend"] = "true";
                        $("#"+key).attr("data-trend", "true");
                    } else {
                        tmp["trend"] = "false";
                        $("#"+key).attr("data-trend","false");
                    }
                    if ($('#background_color').val().length > 0) {
                        tmp["background_color"] = $('#background_color').val();
                    } else {
                        tmp["background_color"] = '#0000';
                    } 
                    // update field
                    $(".title", "#"+key).css("font-size", header["size"] + "px");
                    $(".title", "#"+key).css("font-weight", header["weight"] + "px");
            
            	    unit = {};
            	    unit["title"] = $("#elem_unit_text").val().trim();
            	    //unit["color"] = $(".varval", "#"+key).css("color");
            	    unit["size"] = $("#elem_unit_size").val();
            	    unit["weight"] = $("#elem_unit_style option:selected").val();
                    
                    // update field
                    $(".varval", "#"+key).css("font-size", unit["size"] + "px");
                    $(".unit_title", "#"+key).css("font-size", unit["size"] + "px");
                    $(".varval", "#"+key).css("font-weight", unit["weight"] + "px");
                    
                } else {
            	    tmp["condition"] = $("#"+key).attr("data-cond");
            	    tmp["formula"] = $("#"+key).attr("data-formula");
             	    tmp["lesser"] = $("#"+key).attr("data-lesser");
            	    tmp["larger"] = $("#"+key).attr("data-larger");
                    tmp["decimal"] = $("#"+key).attr("data-decimal") || 2;
             	    //tmp["min"] = $("#"+key).attr("min");
                    //tmp["max"] = $("#"+key).attr("max");
                    tmp["background_color"] = $("#"+key).css("background-color");
                    tmp["linkhtml"] = $("#"+key).attr("data-linkhtml");
                    tmp["trend"] = $("#"+key).attr("data-trend");
            	    header = {};
            	    header["title"] = $(".title", "#"+key).text();
            	    //header["color"] = $(".title", "#"+key).css("color");
            	    header["size"] = parseInt($(".title", "#"+key).css("font-size")) || 28;
            	    header["weight"] = parseInt($(".title", "#"+key).css("font-weight")) || 28;
            
            	    unit = {};
            	    unit["title"] = $(".unit_title", "#"+key).text();
            	    //unit["color"] = $(".varval", "#"+key).css("color");
            	    unit["size"] = parseInt($(".varval", "#"+key).css("font-size")) || 28;
            	    unit["weight"] = parseInt($(".varval", "#"+key).css("font-weight")) || 28;
                }
            	tmp["header"] = header;
            	tmp["unit"] = unit;
            //} else if ( $("#"+key).attr("data-type") == "header" ) {
	    //	        header = {};
	    //	        header["title"] = $(".title", "#"+key).text();
	    //	        header["size"] = $(".title", "#"+key).css("font-size");
	    //	        header["weight"] = $(".title", "#"+key).css("font-weight");
            //	tmp["header"] = header;
            } else if ( $("#"+key).attr("data-type") == "icon" ) {
                if (varname == key) {
                    //var unit_text = $("#elem_unit_text").val();
                    //unit_text = unit_text.trim();
                    //var dtoken = JSON.parse(unit_text);
                    tmp["on"] = $("#onvalue").val();
                    tmp["on_condition"] = $("#onexpression").val();
                    tmp["off"] = $("#offvalue").val();
                    tmp["off_condition"] = $("#offexpression").val();
                    tmp["icon"] = $("#"+key).attr("data-icon");
                    tmp["rotate"] = "rotate(" + $("#rotate").val() + "deg)";

                    if ($('#elem_linkhtml').is(":checked")) {
                        tmp["linkhtml"] = "true";
                        $("#"+key).attr("data-linkhtml", "true");
                    } else {
                        tmp["linkhtml"] = "false";
                        $("#"+key).attr("data-linkhtml","false");
                    }
                    if ($('#elem_trend').is(":checked")) {
                        tmp["trend"] = "true";
                        $("#"+key).attr("data-trend", "true");
                    } else {
                        tmp["trend"] = "false";
                        $("#"+key).attr("data-trend","false");
                    }
                    if ($('#background_color').val().length > 0) {
                        tmp["background_color"] = $('#background_color').val();
                    } else {
                        tmp["background_color"] = '#0000';
                    }
                } else {
                    tmp["rotate"] = $("#"+key).children().css("transform");
                    tmp["icon"] = $("#"+key).attr("data-icon");
                    tmp["on"] = $("#"+key).attr("data-on");
                    tmp["on_condition"] = $("#"+key).attr("data-onexpression");
                    tmp["off"] = $("#"+key).attr("data-off");
                    tmp["off_condition"] = $("#"+key).attr("data-offexpression");
                    tmp["linkhtml"] = $("#"+key).attr("data-linkhtml");
                    tmp["trend"] = $("#"+key).attr("data-trend");
                    tmp["background_color"] = $("#"+key).css("background-color");
                }
		/*
            } else if ( $("#"+key).attr("data-type") == "commbit" ) {
                if (varname == key) {
                    var unit_text = $("#elem_unit_text").val();
                    unit_text = unit_text.trim();
                    var dtoken = JSON.parse(unit_text);
                    tmp["on"] = dtoken["on"];
                    tmp["off"] = dtoken["off"];
                    if ($('#elem_linkhtml').is(":checked")) {
                        tmp["linkhtml"] = "true";
                        $("#"+key).attr("data-linkhtml", "true");
                    } else {
                        tmp["linkhtml"] = "false";
                        $("#"+key).attr("data-linkhtml","false");
                    }
                } else {
                    tmp["on"] = $("#"+key).attr("data-on");
                    tmp["off"] = $("#"+key).attr("data-off");
                    tmp["linkhtml"] = $("#"+key).attr("data-linkhtml");
                }
            } else if ( $("#"+key).attr("data-type") == "alarm" ) {
                if (varname == key) {
                    var unit_text = $("#elem_unit_text").val();
                    unit_text = unit_text.trim();
                    var dtoken = JSON.parse(unit_text);
                    tmp["on"] = dtoken["on"];
                    tmp["off"] = dtoken["off"];
                    if ($('#elem_linkhtml').is(":checked")) {
                        tmp["linkhtml"] = "true";
                        $("#"+key).attr("data-linkhtml", "true");
                    } else {
                        tmp["linkhtml"] = "false";
                        $("#"+key).attr("data-linkhtml","false");
                    }
                } else {
                    tmp["on"] = $("#"+key).attr("data-on");
                    tmp["off"] = $("#"+key).attr("data-off");
                    tmp["linkhtml"] = $("#"+key).attr("data-linkhtml");
                }*/
            } else if ( $("#"+key).attr("data-type") == "integer-to-string" ) {
                if (varname == key) {
                    var unit_text = $("#elem_unit_text").val();
                    unit_text = unit_text.trim();
                    var data_condition = $("#elem_condition_range").val();
                    if ($('#background_color').val().length > 0) {
                        tmp["background_color"] = $('#background_color').val();
                    } else {
                        tmp["background_color"] = '#0000';
                    }
                    if ($('#elem_linkhtml').is(":checked")) {
                        tmp["linkhtml"] = "true";
                        $("#"+key).attr("data-linkhtml", "true");
                    } else {
                        tmp["linkhtml"] = "false";
                        $("#"+key).attr("data-linkhtml","false");
                    }
                    if ($('#elem_trend').is(":checked")) {
                        tmp["trend"] = "true";
                        $("#"+key).attr("data-trend", "true");
                    } else {
                        tmp["trend"] = "false";
                        $("#"+key).attr("data-trend","false");
                    }
            	    tmp["cond"] = data_condition;
            	    tmp["dict"] = unit_text;
             	    
            	    header = {};
            	    header["title"] = $("#elem_title_text").val().trim();
            	    header["size"] = $("#elem_title_size").val();
            	    header["weight"] = $("#elem_title_style option:selected").val();
            
            	    unit = {};
            	    //unit["color"] = $(".varval", "#"+key).css("color");
            	    unit["size"] = $("#elem_unit_size").val();
            	    unit["weight"] = $("#elem_unit_style option:selected").val();
                } else {
            	    tmp["dict"] = $("#"+key).attr("data-dict");
            	    tmp["cond"] = $("#"+key).attr("data-cond");
            	    tmp["background_color"] = $("#"+key).css("background-color");
                    tmp["linkhtml"] = $("#"+key).attr("data-linkhtml");
                    tmp["trend"] = $("#"+key).attr("data-trend");
                    header = {};
            	    header["title"] = $(".title", "#"+key).text();
            	    //header["color"] = $(".title", "#"+key).css("color");
            	    header["size"] = $(".title", "#"+key).css("font-size");
            	    header["weight"] = $(".title", "#"+key).css("font-weight");
            
            	    unit = {};
            	    //unit["title"] = $(".unit_title", "#"+key).text();
            	    //unit["color"] = $(".varval", "#"+key).css("color");
            	    unit["size"] = $(".varval", "#"+key).css("font-size");
            	    unit["weight"] = $(".varval", "#"+key).css("font-weight");
                }
            	tmp["header"] = header;
            	tmp["unit"] = unit;
            }
            position[key] = tmp;
        }
        }
    });
    
    $('[id^=header_]').each(function( index ) {
        tmp = {};
        var hkey = $( this ).attr('id');
        tmp["left"] = $("#"+hkey).css("left");
        tmp["top"] = $("#"+hkey).css("top");
        tmp["width"] = $("#"+hkey).width();
        tmp["height"] = $("#"+hkey).height();
        tmp["type"] = $("#"+hkey).attr("data-type");
        header = {};
        if (token == hkey) {
            header["title"] = $("#elem_title_text").val().trim();
            //header["color"] = $(".title", "#"+key).css("color");
            header["size"] = $("#elem_title_size").val();
            header["weight"] = $("#elem_title_style option:selected").val();
            if ($('#titlelink').val().length > 0) {
                tmp["titlelink"] = $('#titlelink').val();
            }
            if ($('#background_color').val().length > 0) {
                tmp["background_color"] = $('#background_color').val();
            } else {
                tmp["background_color"] = '#0000';
            }
            // update field
            $(".title", "#"+hkey).css("font-size", header["size"] + "px");
            $(".title", "#"+hkey).css("font-weight", header["weight"]);
            
        } else {
            header["title"] = $(".title", "#"+hkey).text();
            //header["color"] = $(".title", "#"+hkey).css("color");
            header["size"] = parseInt($(".title", "#"+hkey).css("font-size")) || 28;
            header["weight"] = parseInt($(".title", "#"+hkey).css("font-weight")) || 28;
            tmp["background_color"] = $("#"+hkey).css("background-color");
            tmp["titlelink"] = $("#"+hkey).attr("data-titlelink");
	    var fontWeight = $(".title", "#"+hkey).css("font-weight");
	    if (fontWeight == 'bold' || fontWeight == '700') {
		header["weight"] = "700";
	    } else {
		header["weight"] = "400";
	    }
        }
        tmp["header"] = header;
        position[hkey] = tmp;
        tmp["type"] = "header";
        
    });
    
    $('[id^=calc_]').each(function( index ) {
      var tmp = {};
        var key = this.id;
        if($("#" + key).length > 0 ) {
            tmp["ref"] = "";
            tmp["left"] = $("#"+key).css("left");
            tmp["top"] = $("#"+key).css("top");
            tmp["width"] = $("#"+key).width();
            tmp["height"] = $("#"+key).height();
            tmp["type"] = $("#"+key).attr("data-type");
            //if ( $("#"+key).attr("data-type") == "calc" ) {
                if (varname == key) {
            	    tmp["condition"] = $("#elem_condtion_range").val();
            	    tmp["formula"] = $("#elem_formula").val();
             	    tmp["lesser"] = $("#elem_lesser_range").val();
            	    tmp["larger"] = $("#elem_larger_range").val();
                    tmp["decimal"] = $("#decimal_place").val();
            
            	    header = {};
            	    header["title"] = $("#elem_title_text").val().trim();
            	    //header["color"] = $(".title", "#"+key).css("color");
            	    header["size"] = $("#elem_title_size").val();
            	    header["weight"] = $("#elem_title_style option:selected").val();
                    
                    if ($('#background_color').val().length > 0) {
                        tmp["background_color"] = $('#background_color').val();
                    } else {
                        tmp["background_color"] = '#0000';
                    }
 
            	    unit = {};
            	    unit["title"] = $("#elem_unit_text").val().trim();
            	    //unit["color"] = $(".varval", "#"+key).css("color");
            	    unit["size"] = $("#elem_unit_size").val();
            	    unit["weight"] = $("#elem_unit_style option:selected").val();
                    
                } else {
            	    tmp["condition"] = $("#"+key).attr("data-cond");
            	    tmp["formula"] = $("#"+key).attr("data-formula");
             	    tmp["lesser"] = $("#"+key).attr("data-lesser");
            	    tmp["larger"] = $("#"+key).attr("data-larger");
		    tmp["decimal"] = $("#"+key).attr("data-decimal") || 2;
             	    //tmp["min"] = $("#"+key).attr("min");
           	        //tmp["max"] = $("#"+key).attr("max");
                    tmp["background_color"] = $("#"+key).css("background-color"); 
            	    header = {};
            	    header["title"] = $(".title", "#"+key).text();
            	    //header["color"] = $(".title", "#"+key).css("color");
                    header["size"] = parseInt($(".title", "#"+key).css("font-size")) || 28;
            	    header["weight"] = $(".title", "#"+key).css("font-weight");
            
            	    unit = {};
            	    unit["title"] = $(".unit_title", "#"+key).text();
            	    //unit["color"] = $(".varval", "#"+key).css("color");
                    unit["size"] = parseInt($(".varval", "#"+key).css("font-size")) || 28;
            	    unit["weight"] = $(".varval", "#"+key).css("font-weight");
                }
            	tmp["header"] = header;
            	tmp["unit"] = unit;
            	tmp["type"] = "calc";
            //}
            position[key] = tmp;
        }
    });
    
    $('*[data-type="rtsp"]').each(function( index ) {
        tmp = {};
        var key = $( this ).attr('id');
        tmp["left"] = $("#"+key).css("left");
        tmp["top"] = $("#"+key).css("top");
        tmp["width"] = Math.round($("#"+key).width());
        tmp["height"] = Math.round($("#"+key).height());
        tmp["type"] = $("#"+key).attr("data-type");
        position[key] = tmp;
    });
    
    $('*[data-type="rest"]').each(function( index ) {
        tmp = {};
        var key = $( this ).attr('id');
        tmp["left"] = $("#"+key).css("left");
        tmp["top"] = $("#"+key).css("top");
        tmp["type"] = $("#"+key).attr("data-type");
        tmp["width"] = Math.round($("#"+key).width());
        tmp["height"] = Math.round($("#"+key).height());
        tmp["background-color"] = $("#"+key).css("background-color");
        
        header = {};
        header["size"] = $("#"+key+ " > p >span").css("font-size");
        header["weight"] = $("#"+key + " > p > span").css("font-weight");
        header["title"] = $("#"+key + " > p > span").text();
        
        input = {};
        input["size"] = $("#"+key + " > p > input").css("font-size");
        input["weight"] = $("#"+key + " > p > input").css("font-weight");
        //input["width"] = $("#"+key + " > p > input").css("width");
        
        tmp["header"] = header;
        tmp["input"] = input;
        position[key] = tmp;
    });
    
    var dataToSend = JSON.stringify(position);
    
    $.ajax({
        url: '/save/',
        type: 'POST',
        data: dataToSend,
        success: function (response) {
            //var objresponse = JSON.parse(response);
            alert("Save success!");
            location.reload();
        },
        error: function () {

        }
    });
}

function isNumeric(value) {
    return /^\d+$/.test(value);
}
    
/******************************
*
* bora 2.0 functions
*
******************************/


function uuidv4() {
  return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
    (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
  );
}


/*********** Adding an html element to the page ***********/
// Helper function: Verifies that the required fields are filled
function verifyRequiredFields(item, prefix) {
    if (!["text", "box", "calc", "virtual", "clone"].includes(prefix)) {
        if ( (item.endsWith("must-data") && !params[item]) || (item.endsWith("must-nodata") && !params[item]) ){
            alert("please enter value for " + item);
        return false;
        }
    } else {
        if ( (item.endsWith("must-data") && !params[item] && item != prefix +"-div-name-must-data") ||(item.endsWith("must-nodata") && !params[item] && item != prefix +"-div-name-must-nodata")  ) {
            alert("please enter value for " + item);
            return false;
         }
    }
    return true;
}

// Helper function: Creates a unique ID for each HTML element
function createItemId(item, prefix) {
    if (["text", "box"].includes(prefix)) {
        // For "box" and "text" plugins
        let value = params[prefix + "-div-text_name-must-nodata"];
        value = value.replace(/[^a-zA-Z0-9]/g, "");
        return prefix + "_" + value;
    } else if (["calc", "virtual", "clone"].includes(prefix)) {
        return prefix + "_" + uuidv4().split("-")[0];
    } else {
        return params[prefix + "-div-name-must-nodata"];
    }
}

// Helper function: Creates the div head of the HTML element
function createDivHead(item, item_id, item_array) {
    if (item_array[2] == "icon_type") {
        if (params[item] == "valve" || "commbit" || "alarm" || "TMP" || "bottle" || "relay" || "switch") {
            div_head = "<div " + "class='varbox box_highlight' " +"id=" + item_id + " " + "data-type='"+ item_array[0].replace(/_/g, '-') + "' " + "icon-type='"+ params[item] + "' ";
        }
    } else {
        div_head = "<div " + "class='varbox box_highlight' " +"id=" + item_id + " " + "data-type='"+ item_array[0].replace(/_/g, '-') + "' ";
    }
    return div_head;
}

// Helper function: Creates the div text of the HTML element
function createDivText(item, div_text, item_array) {

    switch (item_array[2]) {
        case "text_name":
            div_text += "<span class='text_name'>" + params[item] + "</span> ";
            break;
        case "unit_name":
            if (params[item]) {
                div_text += "<span class='value'>XXX.XX</span> ";
                div_text += "<span class='unit_name'>" + params[item] + "</span> ";
            }
            break;
        case "int_to_str":
            div_text += "<span>???</span>";
            break;
    }
    return div_text;
}

// Helper function: Creates the CSS style of the HTML element
function createDivStyle(item, div_style, item_array) {
   
    if (item_array[item_array.length -1] == "nodata") {
        
        if (["name", "text_name", "unit_name", "int_to_str"].indexOf(item_array[2]) === -1) {
            css_property = item_array[2].replace(/_/g, '-');
            div_style += css_property + ":" + params[item] + "; ";
        }
    }
    return div_style;
}

// Helper function: Creates the data attributes to be encoded into the HTML element
function createDivData(item, div_data, item_array) {
    if (item_array[item_array.length -1] == "data") {
    
        if (item_array[2] == "int_to_str") {
            data_property = item_array[2].replace(/_/g, '-');
            div_data += "data-" + data_property + '="' + params[item].replace(/"/g, "'") + '" ';
        } else {
            data_property = item_array[2].replace(/_/g, '-');
            div_data += "data-" + data_property + '="' + params[item] + '" ';
        }
        
    }
    return div_data;
}


// Helper function: Adds 'px' to the numeric values
function handleNumericValues(item) {
    var item_array = item.split('-');
    encode_data = item_array[item_array.length - 1]; 

    if (encode_data == "nodata") {
        if (isNumeric(params[item])) {
            params[item] += "px";
        }
    }
}

// Helper function: Converts the font_weight to a numeric value
function handleFontWeight(item, item_array ) {
    if (item_array[2] === "font_weight") {
        if (params[item] === "normal") {
            params[item] = "400";
        } else {
            params[item] ="700";
        }
    }
}

// Helper function: Assemebels the html element 
function createHtmlElement(div_head, div_data, div_style, div_text, prefix) {
    var html_element = div_head + div_data + div_style + "'>" + div_text;
    switch (prefix){
        case "input":
            html_element += input_head + input_style + input_end + input_text;
            break;
        case "icon":
                // TODO: NTJ -> Bug
                var icon_src = window.location.origin + "/static/" + params["icon-div-icon_type-must-data"]  + "_inactive.png";
                //var icon_src = "/static/" + params["icon-div-icon_type-must-nodata"]  + "_inactive.png";
                html_element += "<img src='" + icon_src + "' width='100%' height='100%'></img>";
            break;
        case "button":
            html_element += button_head + button_style + button_end;
            break;
    }
    return html_element += "</div>";
}

// Helper function: Checks if an element with the same ID already exists
function checkExistingElement(item_id) {
    var exists = false;
    $('body [id]').each(function() {
        if ($(this).attr("id") == item_id) {
            exists = true;
            return false; // Stop the loop
        }
    });
    return exists;
}

// Helper function: Adds the HTML element to the page if it doesn't exist
function addHtmlElement(html_element, item_id) {
    var elementExists = checkExistingElement(item_id);
    // If an element with the same ID doesn't exist, append the HTML element to the body
    if (!elementExists) {
        $("body").append(html_element);
        $("#" + item_id).draggable();
        $("#" + item_id).resizable();
    } else {
        alert("UI element with the same ID already exists!");
    }
}

// Main function: bora_add
function bora_add(prefix) {
    var item_id;
    var div_text = "";
    var div_data = "";
    var div_style = " style='position: absolute; top:200px; left:200px; ";

    for (item in params) {
        if (item.startsWith(prefix)) {
            if (!verifyRequiredFields(item, prefix)) { return; }
            var item_array = item.split('-');
            var item_id = createItemId(item,prefix);
            handleNumericValues(item);
            handleFontWeight(item,item_array);
            div_head = createDivHead(item, item_id, item_array);
            div_data = createDivData(item, div_data, item_array);
            div_text = createDivText(item, div_text, item_array);
            div_style = createDivStyle(item, div_style, item_array);
        }
    }

    html_element = createHtmlElement(div_head, div_data, div_style, div_text, prefix);
    addHtmlElement(html_element, item_id);
}


/*********** Selecting an html element from the page ***********/
// Helper function: changes the color of the selected element
function highlightSelectedElement(element_id) {
    $('body [id]').each(function() {
     $(this).toggleClass("box_highlight", $(this).attr("id") === element_id);
    });
}

// Helper function: fetches the text of the selected element
function getElementText(element_id, item) {
    var textName = $("#" + element_id + "> .text_name").text();
    return textName;
}

function getElementUnit(element_id, item) {
    var unitName = $("#" + element_id + "> .unit_name").text();
    return unitName;
}

function getIconType(element_id, item) {
    var icon_src = $("#" + element_id).find("img").attr("src");
    var icon_type = icon_src.substring(icon_src.lastIndexOf("/") + 1, icon_src.lastIndexOf("_inactive.png"));
    return params[item] = icon_type;
}

function getOnCondition(element_id, item) {
    var condition = $("#" + element_id).attr("data-onCondition");
    return params[item] = condition || "";
}

function getOffCondition(element_id, item) {
    var condition = $("#" + element_id).attr("data-offCondition");
    return params[item] = condition || "";
}

function getFormula(element_id, item) {
    var formula = $("#" + element_id).attr("data-formula");
    return params[item] = formula || "";
}

function getVirtualID(element_id, item) {
    var virtual_id = $("#" + element_id).attr("data-virtual-id");
    return params[item] = virtual_id || "";
}

function getCloneID(element_id, item) {
    var clone_id = $("#" + element_id).attr("data-clone-id");
    return params[item] = clone_id || "";
}

function getDecimal(element_id, item) {
    var decimalNumbers = $("#" + element_id).attr("data-decimal-numbers");
    return params[item] = decimalNumbers || "";
}

function getSmaller(element_id, item) {
    var smallerThan = $("#" + element_id).attr("data-smaller-than");
    return params[item] = smallerThan || "";
}

function getIntegerToString(element_id, item) {
    var integerToString = $("#" + element_id).attr("data-int-to-str");
    return params[item] = integerToString || "";
}

function getLarger(element_id, item) {
    var largerThan = $("#" + element_id).attr("data-larger-than");
    return params[item] = largerThan || "";
}

function getTitleLink(element_id, item) {
    var titleLink = $("#" + element_id).attr("data-title-link");
    return params[item] = titleLink || "";
}

// Helper function: changes the font_weight value from numeric to string
function interpretFontWeight(font_weight_value) {
    switch (font_weight_value) {
        case "400": return "normal";
        case "700": return "bold";
    return font_weight_value;
    }
}

// Helper function: fetches the css style properties of the element
function getElementStyle(element_id, item, item_array) {
    var css_property = item_array[2].replace(/_/g, '-');
    var css_property_value = $("#"+ element_id).css(css_property);

    if (css_property_value !== undefined) {
        if (css_property_value.indexOf("px") > 0) {
            return params[item] = parseInt(css_property_value);
        } else {
            if (css_property.localeCompare("font-weight")==0) {
                return params[item] = interpretFontWeight(css_property_value);
            } else {
                return params[item] = css_property_value;
            }
        }
    } else {
        return params[item] = css_property_value;
    }
}

// Main Function: bora_select
function bora_select(prefix) {
    var element_id = params[prefix + "-div-name-must-nodata"];
    highlightSelectedElement(element_id);
    
    for (item in params) {
        if (item.startsWith(prefix)) {
            var item_array = item.split("-");
            if (item_array[1] == "div") {
                if (item_array[2] == "name") {
                    // do nothing
                } else if (item_array[2] == "text_name") {
                    params[item] = getElementText(element_id, item);
                } else if (item_array[2] == "unit_name") {
                    params[item] = getElementUnit(element_id, item);
                } else if (item_array[2] == "onCondition") {
                    params[item] = getOnCondition(element_id, item);
                } else if (item_array[2] == "offCondition") {
                    params[item] = getOffCondition(element_id, item);
                } else if (item_array[2] == "formula") {
                    params[item] = getFormula(element_id, item);
                } else if (item_array[2] == "virtual_id") {
                    params[item] = getVirtualID(element_id, item);
                } else if (item_array[2] == "clone_id") {
                    params[item] = getCloneID(element_id, item);
                } else if (item_array[2] == "decimal_numbers") {
                    params[item] = getDecimal(element_id, item);
                } else if (item_array[2] == "smaller_than") {
                    params[item] = getSmaller(element_id, item);
                } else if (item_array[2] == "larger_than") {
                    params[item] = getLarger(element_id, item);
                } else if (item_array[2] == "int_to_str") {
                    params[item] = getIntegerToString(element_id, item);
                } else if (item_array[2] == "icon_type") {
                    params[item] = getIconType(element_id, item);
                } else if (item_array[2] == "title_link") {
                    params[item] = getTitleLink(element_id, item);
                } else {
                    if (item_array[item_array.length - 1] == "nodata") {
                        params[item] = getElementStyle(element_id, item, item_array);
                    } else {
                        var myvalue = $("#" + element_id).attr("data-" + item_array[2].replace(/_/g, '-'));
                        myvalue = (myvalue === 'true');
                        params[item] = myvalue;
                        
                    }
                }
            }
        }
    }
    gui.updateDisplay();
}


/*********** Updates the properties of an html element ***********/
// Helper Function: updates the text
function updateElementText(item, element_id) {
    $("#" + element_id + "> .text_name").text(params[item]);
}

// Helper Function: updates the unit part of the text
function updateElementUnit(item, element_id) {
    $("#" + element_id + "> .unit_name").text(params[item]);
}

// Helper Function: updates the integer to string part of the text
function updateIntegerToString(item, element_id) {
    $("#" + element_id).attr('data-int-to-str', params[item]);
}

function updateOnCondition(item, element_id) {
    $("#" + element_id).attr('data-onCondition', params[item]);
}

function updateOffCondition(item, element_id) {
    $("#" + element_id).attr('data-offCondition', params[item]);
}

function updateFormula(item, element_id) {
    $("#" + element_id).attr('data-formula', params[item]);
}

function updateVirtualID(item, element_id) {
    $("#" + element_id).attr('data-virtual-id', params[item]);
}

function updateCloneID(item, element_id) {
    $("#" + element_id).attr('data-clone-id', params[item]);
}

function updateDecimal(item, element_id) {
    $("#" + element_id).attr('data-decimal-numbers', params[item]);
}

function updateSmaller(item, element_id) {
    $("#" + element_id).attr('data-smaller-than', params[item]);
}

function updateLarger(item, element_id) {
    $("#" + element_id).attr('data-larger-than', params[item]);
}

function updateFontSize(item, element_id) {
    $("#" + element_id).css('font-size', parseInt(params[item]) + 'px'); 
}

function updateExp(item, element_id) {
    $("#" + element_id).attr('data-exp', params[item]);
}

function updateLinkAdei(item, element_id) {
    $("#" + element_id).attr('data-link-adei', params[item]);
}

function updateTrend(item, element_id) {
    $("#" + element_id).attr('data-trend', params[item]);
}

function updateTitleLink(item, element_id) {
    $("#" + element_id).attr('data-title-link', params[item]);
}

// Helper Function: updates the css style properties
function updateElementStyle(item, element_id, css_property) {
    $("#" + element_id).css(css_property, params[item]);
}

// Main Function: bora_update
function bora_update(prefix) {
    
    for (var item in params) {
        if (item.startsWith(prefix)) {
            var item_array = item.split("-");
            var element_id = params[prefix + "-div-name-must-nodata"];
            var css_property = item_array[2].replace(/_/g, '-');

            if (item_array[1] == "div") {
                switch (item_array[2]) {
                    case "name":
                    // Handle the name case if needed
                        break;
                    case "text_name":
                        updateElementText(item, element_id);
                        break;
                    case "unit_name":
                        updateElementUnit(item, element_id);
                        break;
                    case "font_size":
                        updateFontSize(item, element_id);
                        break;
                    case "onCondition":
                        updateOnCondition(item, element_id);
                        break;
                    case "offCondition":
                        updateOffCondition(item, element_id);
                        break;
                    case "formula":
                        updateFormula(item, element_id);
                        break;
                    case "virtual_id":
                        updateVirtualID(item, element_id);
                        break;
                    case "clone_id":
                        updateCloneID(item, element_id);
                        break;
                    case "decimal_numbers":
                        updateDecimal(item, element_id);
                        break;
                    case "smaller_than":
                        updateSmaller(item, element_id);
                        break;
                    case "larger_than":
                        updateLarger(item, element_id);
                        break;
                    case "int_to_str":
                        updateIntegerToString(item, element_id);
                        break;
                    case "exp":
                        updateExp(item, element_id);
                        break;
                    case "link_adei":
                        updateLinkAdei(item, element_id);
                        break;
                    case "trend":
                        updateTrend(item, element_id);
                        break;
                    case "title_link":
                        updateTitleLink(item, element_id);
                        break;
                    default:
                        updateElementStyle(item, element_id, css_property);
                        break;
                }
            }
        }
    }
    gui.updateDisplay();
}


/********* Removes an html element from the page **********/
// Main Function: bora_remove
function bora_remove(prefix) {
    $("#"+ params[prefix+"-div-name-must-nodata"]).remove();
}


/********* Save the elements created ********/
// Helper Function: gets the element position and type
function extractElementAttributes(element_id) {
    return {
        "left": $("#" + element_id).css("left"),
        "top": $("#" + element_id).css("top"),
        "width": Math.round($("#" + element_id).width()),
        "height": Math.round($("#" + element_id).height()),
        "type": $("#" + element_id).attr("data-type")
    };
}

// Helper Function: gets the div attributes properties of an element
function collectDivAttributes(element_id, category) {
    let mydiv = {};
    mycat = category.replace(/-/g, '_'); 

    for (item in params) {
        if (item.startsWith(mycat)) {
            var item_array = item.split("-");
            var css_property = item_array[2].replace(/_/g, '-');
         
            if (item_array[1] == "div") {
                switch (item_array[2]) {
                case "text_name":
                    mydiv[css_property] = $("#" + element_id + "> .text_name").text().trim();
                    break;
                case "unit_name":
                    mydiv[css_property] = $("#"+ element_id + "> .unit_name").text().trim();
                    break;
                case "int_to_str":
                    let value = $("#" + element_id).attr("data-int-to-str");
                    mydiv["data-int-to-str"] = value.replace(/'/g, '"');
                    break;
                default:
                    if (item_array[item_array.length - 1] == "nodata") {
                        mydiv[css_property] = $("#" + element_id).css(css_property);
                    } else {
                        mydiv["data-" + css_property] = $("#" + element_id).attr("data-" + css_property);
                    }
                    break;
                }
            } 
        }
    }
    return mydiv;
}

// Helper function: sends the element data to the server
function sendDataToServer(dataToSend) {
    $.ajax({
        url: '/save/',
        type: 'POST',
        data: dataToSend,
        success: function (response) {
            alert("Save success!");
            location.reload();
        },
        error: function () {
            alert("Error saving data!");
        }
    });
}

// Main function: bora_save
function bora_save() {
    var position = {};
    var mycategory;

    category.forEach(function(cat)
    {
        mycategory = cat.replace(/_/g, '-');
        $('*[data-type="' + mycategory + '"]').each(function() {
            var element_id = $(this).attr('id');
            var attributes = extractElementAttributes(element_id);
            var styles = collectDivAttributes(element_id, mycategory);

            attributes["widget"] = mycategory;
            attributes["div"] = styles;
            position[element_id] = attributes;
        });
    });

    var dataToSend = JSON.stringify(position);
    sendDataToServer(dataToSend);
}


/********* Backup the elements created ********/
// Main Function: bora_backup
function bora_backup() {
    $.ajax({
        url: '/backup/',
        type: 'POST',
        success: function (response) {
            alert("Backup success!");
        },
        error: function () {
        }
    });
}


var obj = {
select:function(...args){
bora_select(...args);
},
update:function(...args){
bora_update(...args);
},
add:function(...args){
bora_add(...args);
},
remove:function(...args){
bora_remove(...args);
},
save:function(...args){
bora_save(...args);
},
backup:function(...args){
bora_backup();
}
};


gui = new dat.GUI();
var mygroup;
var subdata;
var folder;

var params = {};
var category = [];
var tmp_color;
var bind_param;
var opt = "";
var encode_data = "";

var plugin_arrays = {};
var plugin_folder = gui.addFolder("plugins");

gui.add(obj, 'save');
gui.add(obj, 'backup');

{% for category in data["typedef"] %}

    folder = gui.addFolder("{{ category }}");
    
    category.push("{{ category }}");

    plugin_arrays.{{ category }} = true;
    
    mygroup = {};

    mygroup["{{ category }}" + "-div-name-must-nodata"] = [];

    {% for item in data["style"] %}
    
        {% if category in ['box', 'text', 'calc', 'virtual', 'clone'] %}
            mygroup["{{ category }}" + "-div-name-must-nodata"].push("{{item}}");
            $("#" + "{{ item }}").draggable();
            $("#" + "{{ item }}").resizable();
        {% end %}    
    {% end %}

    {% for key, value in data["vardata"].items() %}
        {% if category not in ['box', 'text', 'calc', 'virtual', 'clone'] %}
            mygroup["{{ category }}" + "-div-name-must-nodata"].push("{{ key }}");
        {% end %}
    {% end %}

    bind_param = '{{ category }}';
    params[ bind_param + "-div-name-must-nodata"] = "";    

    folder.add(params,  bind_param + "-div-name-must-nodata", mygroup["{{ category }}" + "-div-name-must-nodata"] ).name("name");
    
    folder.add({select : obj.select.bind(this, bind_param  )}, "select");
    folder.add({update : obj.update.bind(this, bind_param )}, "update");

    {% for element in data["typedef"][category] %}
        
        {% for item in data["typedef"][ category ][element] %}
            
            if ('{{ data["typedef"][ category ][element][item]["optional"] }}' == "Yes") {
                opt = "opt"
            } else {
                opt = "must"
            }
            
            if ('{{ data["typedef"][ category ][element][item]["data"] }}' == "Yes") {
                encode_data = "data";
            } else {
                encode_data = "nodata"
            }
            
            if ('{{ data["typedef"][ category ][element][item]["type"] }}' == "string") { // STRING
                params[ bind_param + "-" + '{{ element }}' + "-" + '{{ item }}' + "-" + opt + "-" + encode_data] = '{{ data["typedef"][ category ][element][item]["value"] }}';
            } else if ('{{ data["typedef"][ category ][element][item]["type"] }}' == "bool") { // BOOL
                if ('{{ data["typedef"][ category ][element][item]["value"] }}' == "True") {
                    params[ bind_param + "-" + '{{ element }}' + "-" + '{{ item }}'  + "-" + opt + "-" + encode_data] = true;
                } else {
                    params[ bind_param + "-" + '{{ element }}' + "-" + '{{ item }}'  + "-" + opt + "-" + encode_data] = false;
                }
                folder.add(params, bind_param + "-" + '{{ element }}' + "-" + '{{ item }}' + "-" + opt + "-" + encode_data).name('{{ item }} ' +  "[" + "{{ element }}" + "]");
            } else if ('{{ data["typedef"][ category ][element][item]["type"] }}' == "color") {
                tmp_color = "rgba(";
                {% for subcolor in data["typedef"][ category ][element][item]["value"] %}
                    tmp_color += "{{ subcolor }}";
                    tmp_color += ",";
                {% end %}
                tmp_color = tmp_color.slice(0, -1);
                tmp_color += ")";
                params[ bind_param + "-"+ '{{ element }}' + "-" + '{{ item }}' + "-" + opt + "-" + encode_data] = tmp_color;
                
            } else if ('{{ data["typedef"][ category ][element][item]["type"] }}' == "select"){
                {% if (item == "icon_type") %}
                    var iconOptions = ["valve", "commbit", "alarm", "TMP", "bottle", "relay", "switch"];
                    params[ bind_param + "-" + '{{ element }}' + "-" + '{{ item }}' + "-" + opt + "-" + encode_data] = '{{ data["typedef"][ category ][element][item]["value"] }}';
                    folder.add(params, bind_param + "-" + '{{ element }}' + "-" + '{{ item }}' + "-" + opt + "-" + encode_data, iconOptions).name('{{ item }} ' + "{{ element }}");
                {% else %}
                    // item == "font-weight"
                    var weightOptions = ["normal", "bold"];
                    params[ bind_param + "-" + '{{ element }}' + "-" + '{{ item }}' + "-" + opt + "-" + encode_data] = '{{ data["typedef"][ category ][element][item]["value"] }}';
                    folder.add(params, bind_param + "-" + '{{ element }}' + "-" + '{{ item }}' + "-" + opt + "-" + encode_data, weightOptions).name('{{ item }} ' + "{{ element }}");
                {% end %}
            } else {
                params[ bind_param + "-"+ '{{ element }}' + "-" + '{{ item }}' + "-" + opt + "-" + encode_data] = '{{ data["typedef"][ category ][element][item]["value"] }}';
            }

            if (('{{ data["typedef"][ category ][element][item]["type"] }}' != "select") && ('{{ data["typedef"][ category ][element][item]["type"] }}' != "bool")){
                folder.add(params,  bind_param + "-"+ '{{ element }}' + "-" + '{{ item }}'  + "-" + opt + "-" + encode_data).name('{{ item }} ' + "[" + "{{ element }}"+ "]");
            }
        {% end %}
    {% end %}
    
    folder.add({add : obj.add.bind(this, bind_param )}, "add");
    folder.add({remove : obj.remove.bind(this, bind_param )}, "remove");
    {% end %}


// Object to store dat.GUI controllers for plugin checkboxes
var controllers = {};

// Loop through each plugin and create a checkbox
for (const [plugin, visibility] of Object.entries(plugin_arrays)) {
    // Create a checkbox controller for the plugin
    controllers[plugin] = plugin_folder.add(plugin_arrays,plugin).onChange(function (value) {
        // Call the function to toggle the visibility of the plugin folder
        togglePluginFolder(plugin, value);
    });
}

// Function to toggle plugin folder visibility
function togglePluginFolder(plugin, visibility) {
    // Check if the folder exists in dat.GUI
    if (gui.__folders[plugin]) {
        // Set the display style property based on the checkbox value
        gui.__folders[plugin].domElement.style.display = visibility ?'' : 'none';
    }
}

</script>


</body>
</html>
